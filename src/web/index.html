<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedAlert Dashboard</title>
    <link href="https://fonts.googleapis.com/css?family=Orbitron:700,500|Exo+2:400,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #10131a;
            --sidebar: #181c26cc;
            --card: #181c26ee;
            --glass: rgba(24,28,38,0.85);
            --primary: #1bb6ff;
            --secondary: #7f5fff;
            --accent: #ff3366;
            --text: #eaf6ff;
            --subtext: #7fa7c7;
            --shadow: 0 8px 32px 0 #1bb6ff22;
            --border: #23273a;
            --danger: #ff3366;
        }
        html, body {
            margin: 0; padding: 0; min-height: 100vh;
            font-family: 'Exo 2', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
        }
        body {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 80px;
            background: var(--sidebar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 0 1rem 0;
            box-shadow: 2px 0 24px #1bb6ff11;
            border-right: 1.5px solid var(--border);
        }
        .sidebar .logo {
            margin-bottom: 2.5rem;
        }
        .sidebar svg {
            width: 48px; height: 48px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 8px #1bb6ff55);
        }
        .sidebar .nav {
            display: flex;
            flex-direction: column;
            gap: 2.2rem;
        }
        .sidebar .nav-btn {
            background: none;
            border: none;
            color: var(--subtext);
            font-size: 1.7em;
            cursor: pointer;
            transition: color 0.2s;
        }
        .sidebar .nav-btn.active, .sidebar .nav-btn:hover {
            color: var(--primary);
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(120deg, #10131a 60%, #181c26 100%);
        }
        .dashboard {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2.5rem 2.5rem 2rem 2.5rem;
            gap: 2.2rem;
        }
        .widgets {
            display: flex;
            gap: 2.2rem;
            flex-wrap: wrap;
        }
        .card {
            background: var(--card);
            border-radius: 22px;
            box-shadow: 0 4px 32px #1bb6ff22, 0 1.5px 0 #23273a;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            border: 1.5px solid var(--border);
            min-width: 300px;
            flex: 1 1 340px;
            max-width: 540px;
            position: relative;
            backdrop-filter: blur(10px);
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .card h2 {
            color: var(--primary);
            font-family: 'Orbitron', Arial, sans-serif;
            font-size: 1.18rem;
            margin-top: 0;
            letter-spacing: 1px;
            font-weight: 700;
        }
        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 1.3rem;
            margin-top: 1.2rem;
        }
        .alert {
            display: flex;
            align-items: flex-start;
            gap: 1.1em;
            background: linear-gradient(90deg, #1bb6ff33 0%, #7f5fff22 100%);
            border-left: 4px solid var(--primary);
            padding: 1.1rem 1.2rem 1.1rem 1.1rem;
            border-radius: 14px;
            box-shadow: 0 2px 16px #1bb6ff22, 0 0 0 0 #1bb6ff00;
            color: var(--text);
            position: relative;
            transition: box-shadow 0.18s, border-color 0.18s, background 0.18s;
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            animation: alertin 0.7s cubic-bezier(.4,1.6,.6,1) forwards;
        }
        .alert:hover {
            box-shadow: 0 4px 32px #1bb6ff55, 0 0 0 2px #1bb6ff33;
            background: linear-gradient(90deg, #1bb6ff55 0%, #7f5fff33 100%);
            z-index: 2;
        }
        @keyframes alertin { to { opacity: 1; transform: none; } }
        .alert .avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1bb6ff 60%, #7f5fff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #fff;
            box-shadow: 0 2px 8px #1bb6ff44;
            flex-shrink: 0;
        }
        .alert-content {
            flex: 1;
            min-width: 0;
        }
        .alert .user {
            font-weight: 700;
            color: var(--primary);
            font-family: 'Exo 2', Arial, sans-serif;
            letter-spacing: 1px;
            font-size: 1.08em;
        }
        .alert .date {
            color: var(--subtext);
            font-size: 0.97em;
            margin-left: 0.7em;
        }
        .alert .msg {
            margin-top: 0.25em;
            font-size: 1.11em;
            color: var(--text);
            font-family: 'Exo 2', Arial, sans-serif;
            word-break: break-word;
        }
        header {
            background: var(--glass);
            color: var(--primary);
            padding: 0.7rem 2.2rem 0.5rem 2.2rem;
            border-bottom: 1.5px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1.2rem;
            box-shadow: 0 2px 16px #1bb6ff11;
            min-height: 56px;
        }
        header h1 {
            font-family: 'Orbitron', Arial, sans-serif;
            font-size: 1.18rem;
            letter-spacing: 2px;
            margin: 0;
            font-weight: 700;
            color: var(--primary);
        }
        .subtitle {
            color: var(--secondary);
            font-size: 1em;
            margin-left: auto;
            font-family: 'Exo 2', Arial, sans-serif;
            letter-spacing: 1px;
        }
        @media (max-width: 900px) {
            .dashboard { padding: 1.2rem 0.5rem; }
            .widgets { flex-direction: column; gap: 1.2rem; }
        }
        @media (max-width: 600px) {
            .sidebar { width: 54px; padding: 1rem 0; }
            .sidebar svg { width: 32px; height: 32px; }
            header { padding: 0.7rem 0.7rem; }
            .dashboard { padding: 0.5rem 0.1rem; }
            .card { padding: 1.1rem 0.5rem; min-width: 0; }
            .alert-list { gap: 0.7rem; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <!-- Logo SVG stylis√© -->
            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="32" cy="32" r="28" fill="#10131a" stroke="#1bb6ff" stroke-width="3.5"/>
                <rect x="28" y="16" width="8" height="32" rx="4" fill="#1bb6ff"/>
                <rect x="16" y="28" width="32" height="8" rx="4" fill="#7f5fff"/>
                <circle cx="32" cy="32" r="8" fill="#181c26" stroke="#ff3366" stroke-width="2"/>
            </svg>
        </div>
        <div class="nav">
            <button class="nav-btn active" title="Alertes">
                <span>‚è∫Ô∏è</span>
            </button>
            <button class="nav-btn" title="Statistiques">
                <span>üìä</span>
            </button>
            <button class="nav-btn" title="Param√®tres">
                <span>‚öôÔ∏è</span>
            </button>
        </div>
    </nav>
    <div class="main">
        <header>
            <h1>MedAlert</h1>
            <div class="subtitle">Dashboard m√©dical temps r√©el</div>
        </header>
        <div class="dashboard">
            <div class="widgets" id="widgets">
                <!-- Les widgets seront inject√©s ici selon l‚Äôonglet -->
            </div>
        </div>
    </div>
    <div id="alert-status" style="position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(30,40,60,0.95);color:#fff;padding:0.7em 1.5em;border-radius:18px;font-size:1em;box-shadow:0 2px 16px #1bb6ff55;display:none;"></div>
    <button id="enable-alerts-btn" style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:9999;background:var(--primary);color:#fff;border:none;border-radius:30px;padding:0.7em 2em;font-size:1.1em;box-shadow:0 2px 16px #1bb6ff55;display:none;">Activer les alertes</button>
    <button id="push-status-btn" style="position:fixed;bottom:180px;left:50%;transform:translateX(-50%);z-index:9999;background:#00d4ff;color:#222;border:none;border-radius:30px;padding:0.6em 1.5em;font-size:1em;box-shadow:0 2px 16px #00d4ff55;">√âtat abonnement push</button>
    <div id="push-status-info" style="position:fixed;bottom:140px;left:50%;transform:translateX(-50%);z-index:9999;background:#23273aee;color:#fff;padding:0.7em 1.5em;border-radius:18px;font-size:0.95em;box-shadow:0 2px 16px #1bb6ff55;display:none;max-width:90vw;text-align:center;"></div>
    <button id="test-notif-btn" style="position:fixed;bottom:110px;left:50%;transform:translateX(-50%);z-index:9999;background:var(--secondary);color:#fff;border:none;border-radius:30px;padding:0.6em 1.5em;font-size:1em;box-shadow:0 2px 16px #7f5fff55;">Tester notification</button>
    <div id="pwa-ios-hint" style="position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;background:#23273aee;color:#fff;padding:0.7em 1.5em;border-radius:18px;font-size:1em;box-shadow:0 2px 16px #1bb6ff55;display:none;max-width:90vw;text-align:center;"></div>
    <audio id="alert-audio" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b2.mp3" preload="auto"></audio>
    <script>
        // Navigation sidebar
        const navBtns = document.querySelectorAll('.nav-btn');
        let currentTab = 0;
        function setTab(idx) {
            navBtns.forEach((b,i)=>b.classList.toggle('active',i===idx));
            currentTab = idx;
            renderWidgets();
        }
        navBtns.forEach((b,i)=>b.onclick=()=>setTab(i));

        function renderWidgets() {
            const widgets = document.getElementById('widgets');
            widgets.innerHTML = '';
            if (currentTab === 0) {
                // Alertes
                widgets.innerHTML = `
                <div class="card" style="max-width: 520px;">
                    <h2>Alertes r√©centes</h2>
                    <button class="refresh-btn" onclick="refreshAlerts()">‚ü≥ Actualiser</button>
                    <div id="alert-list" class="alert-list"></div>
                </div>
                `;
                fetchAlerts();
            } else if (currentTab === 1) {
                // Statistiques
                widgets.innerHTML = `
                <div class="card">
                    <h2>Statistiques</h2>
                    <div style="color:var(--subtext);font-size:1.1em;">Module statistiques √† venir‚Ä¶</div>
                </div>
                `;
            } else if (currentTab === 2) {
                // Param√®tres
                widgets.innerHTML = `
                <div class="card">
                    <h2>Param√®tres</h2>
                    <div style="color:var(--subtext);font-size:1.1em;">Module param√®tres √† venir‚Ä¶</div>
                </div>
                `;
            }
        }

        // D√©tection de l‚ÄôURL d‚ÄôAPI backend (IP ou localhost, http ou https selon la page)
        function getApiUrl() {
            return '/api/alerts';
        }
        let lastAlertId = null;
        async function fetchAlerts() {
            const list = document.getElementById('alert-list');
            if (!list) return;
            list.innerHTML = '<div class="loader">Chargement‚Ä¶</div>';
            try {
                const apiUrl = getApiUrl();
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error('Erreur API ('+res.status+")");
                const data = await res.json();
                list.innerHTML = '';
                if (!data.length) {
                    list.innerHTML = '<div style="color:var(--subtext);text-align:center;">Aucune alerte</div>';
                    lastAlertId = null;
                    return;
                }
                // D√©tection nouvelle alerte
                const newest = data[0];
                if (lastAlertId && newest.id !== lastAlertId) {
                    triggerAlertNotification(newest);
                }
                lastAlertId = newest.id;
                data.slice(0,8).forEach(alert => {
                    const user = alert.username || alert.author || 'Inconnu';
                    const date = new Date(alert.createdAt || alert.date).toLocaleString('fr-FR');
                    const msg = alert.originalMessage || alert.message;
                    const avatar = user && user.length > 0 ? user[0].toUpperCase() : 'üë§';
                    const icon = /medic|m√©decin|evac|secours|sant√©|inconscient|blessure|urgence/i.test(msg) ? '‚öïÔ∏è' : avatar;
                    const html = `<div class="avatar">${icon}</div><div class="alert-content"><span class="user">${user}</span> <span class="date">${date}</span><div class="msg">${msg}</div></div>`;
                    const el = document.createElement('div');
                    el.className = 'alert';
                    el.innerHTML = html;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = `<div class="error">Erreur de chargement des alertes<br><span style='font-size:0.95em;color:var(--subtext);'>${e.message}</span></div>`;
            }
        }
        const statusDiv = document.getElementById('alert-status');
        function showStatus(msg, ok=true) {
            statusDiv.textContent = msg;
            statusDiv.style.background = ok ? 'rgba(30,40,60,0.95)' : '#ff3366cc';
            statusDiv.style.display = '';
            setTimeout(()=>{ statusDiv.style.display = 'none'; }, 5000);
        }
        // Service worker pour notifications background
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js', { scope: '/' }).then(reg => {
                showStatus('Service worker actif', true);
                if (!navigator.serviceWorker.controller) {
                    showStatus('Service worker non-contr√¥leur, rechargement‚Ä¶', false);
                    window.location.reload();
                }
                console.log('Service worker enregistr√©', reg);
            }).catch((err)=>{
                showStatus('Service worker non support√©', false);
                console.error('Erreur SW register:', err);
            });
        } else {
            showStatus('Service worker non support√©', false);
        }
        // Bouton d‚Äôactivation alertes (son/notification)
        const enableBtn = document.getElementById('enable-alerts-btn');
        function enableAlerts() {
            if ('Notification' in window) {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') {
                        showStatus('Notifications activ√©es', true);
                    } else {
                        showStatus('Notifications refus√©es', false);
                    }
                });
            }
            const audio = document.getElementById('alert-audio');
            if (audio) { audio.volume = 1; audio.play().then(()=>{
                showStatus('Son d‚Äôalerte activ√©', true);
            }).catch(()=>{
                showStatus('Le navigateur bloque le son tant que vous n‚Äôavez pas interagi.', false);
            }); }
            enableBtn.style.display = 'none';
        }
        // Affiche le bouton si permission notification non accord√©e ou audio bloqu√©
        window.addEventListener('DOMContentLoaded', () => {
            if (Notification.permission !== 'granted') enableBtn.style.display = '';
            enableBtn.onclick = enableAlerts;

            // Bouton diagnostic push
            const pushStatusBtn = document.getElementById('push-status-btn');
            const pushStatusInfo = document.getElementById('push-status-info');
            if (pushStatusBtn && pushStatusInfo) {
                pushStatusBtn.onclick = async () => {
                    if ('serviceWorker' in navigator && 'PushManager' in window) {
                        const reg = await navigator.serviceWorker.ready;
                        const sub = await reg.pushManager.getSubscription();
                        if (sub) {
                            pushStatusInfo.style.display = '';
                            pushStatusInfo.textContent = 'Abonnement push actif : ' + sub.endpoint.slice(0, 48) + '...';
                        } else {
                            pushStatusInfo.style.display = '';
                            pushStatusInfo.textContent = 'Aucun abonnement push trouv√©. Cliquez pour tenter de vous abonner.';
                            // Tente l‚Äôabonnement
                            try {
                                const vapidRes = await fetch('/api/vapid-key');
                                const vapid = await vapidRes.json();
                                const subscribeOptions = {
                                    userVisibleOnly: true,
                                    applicationServerKey: urlBase64ToUint8Array(vapid.publicKey)
                                };
                                const subscription = await reg.pushManager.subscribe(subscribeOptions);
                                await fetch('/api/subscribe', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(subscription)
                                });
                                pushStatusInfo.textContent = 'Abonnement push cr√©√© avec succ√®s !';
                            } catch (e) {
                                pushStatusInfo.textContent = 'Erreur abonnement push : ' + e.message;
                            }
                        }
                    } else {
                        pushStatusInfo.style.display = '';
                        pushStatusInfo.textContent = 'Push API non support√©e sur ce navigateur.';
                    }
                };
            }

            // Abonnement Push API
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(async reg => {
                    // R√©cup√®re la cl√© publique VAPID depuis le backend
                    const vapidRes = await fetch('/api/vapid-key');
                    const vapid = await vapidRes.json();
                    const subscribeOptions = {
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapid.publicKey)
                    };
                    reg.pushManager.getSubscription().then(async sub => {
                        if (!sub) {
                            const subscription = await reg.pushManager.subscribe(subscribeOptions);
                            // Envoie l‚Äôabonnement au backend
                            await fetch('/api/subscribe', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(subscription)
                            });
                            console.log('Abonnement push enregistr√©');
                        } else {
                            console.log('D√©j√† abonn√© aux notifications push');
                        }
                    });
                });
            }

            // Utilitaire pour d√©coder la cl√© VAPID
            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }
        });
        // Diagnostic service worker et notification
        const testBtn = document.getElementById('test-notif-btn');
        testBtn.onclick = () => {
            showStatus('Test notification en cours...', true);
            try {
                console.log('Notification.permission =', Notification.permission);
                if (navigator.serviceWorker) {
                    console.log('SW contr√¥leur ?', !!navigator.serviceWorker.controller, navigator.serviceWorker.controller);
                }
                triggerAlertNotification({
                    username: 'Test',
                    originalMessage: 'Ceci est un test de notification',
                    createdAt: new Date().toISOString()
                });
            } catch (e) {
                showStatus('Erreur JS : ' + e.message, false);
                console.error('Erreur JS notification:', e);
            }
        };
        // Fallback notification directe si tout √©choue
        function triggerAlertNotification(alert) {
            const user = alert.username || alert.author || 'Inconnu';
            const msg = alert.originalMessage || alert.message;
            const date = new Date(alert.createdAt || alert.date).toLocaleTimeString('fr-FR');
            // Son
            const audio = document.getElementById('alert-audio');
            if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
            // Notification push
            if (window.Notification && Notification.permission === 'granted') {
                let notifDone = false;
                try {
                    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'alert-notification',
                            title: 'üö® Nouvelle alerte MedAlert',
                            body: `${user} : ${msg}\n${date}`,
                            icon: '/icon-192.png'
                        });
                        notifDone = true;
                    }
                } catch (e) {
                    showStatus('Erreur SW : ' + e.message, false);
                    console.error('Erreur SW:', e);
                }
                if (!notifDone) {
                    // Attendre que le service worker soit pr√™t avant d'appeler showNotification
                    if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                        navigator.serviceWorker.ready.then(function(reg) {
                            if (reg && reg.showNotification) {
                                reg.showNotification('üö® Nouvelle alerte MedAlert', {
                                    body: `${user} : ${msg}\n${date}`,
                                    icon: '/icon-192.png',
                                    vibrate: [200, 100, 200],
                                    tag: 'medalert',
                                    renotify: true
                                });
                                console.log('Notification SW envoy√©e');
                                if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
                                showStatus('Notification SW', true);
                            } else {
                                showStatus('Erreur : SW non pr√™t', false);
                            }
                        }).catch(function(e) {
                            showStatus('Erreur SW.ready : ' + e.message, false);
                            console.error('Erreur SW.ready:', e);
                        });
                    } else {
                        showStatus('Notifications non autoris√©es ou non support√©es', false);
                    }
                }
            } else {
                showStatus('Notifications non autoris√©es ou non support√©es', false);
            }
        }
        // R√©ception message du service worker pour jouer le son
        if (navigator.serviceWorker) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'play-alert-sound') {
                    const audio = document.getElementById('alert-audio');
                    if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
                }
            });
        }
        // D√©tection iOS et invitation √† installer la PWA
        function isIos() {
            return /iphone|ipad|ipod/i.test(navigator.userAgent);
        }
        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && window.navigator.standalone;
        }
        const pwaHint = document.getElementById('pwa-ios-hint');
        window.addEventListener('DOMContentLoaded', () => {
            // Affiche l‚Äô√©tat SW/Notif au chargement
            setTimeout(() => {
                let msg = 'Notification: ' + Notification.permission;
                if (navigator.serviceWorker) {
                    msg += ' | SW contr√¥leur: ' + (!!navigator.serviceWorker.controller);
                }
                showStatus(msg, Notification.permission === 'granted');
            }, 800);
            // Affiche l‚Äôinvitation iOS si besoin
            if (isIos() && !isInStandaloneMode()) {
                pwaHint.style.display = '';
                pwaHint.innerHTML = 'Pour recevoir les notifications sur iOS, ajoutez MedAlert √† l‚Äô√©cran d‚Äôaccueil via <b>Partager &gt; Sur l‚Äô√©cran d‚Äôaccueil</b>.';
            }
            // Affiche un message si Notification API non dispo
            if (!('Notification' in window)) {
                showStatus('Notifications push non support√©es sur ce navigateur.', false);
            }
        });
        // Initialisation
        renderWidgets();
        setInterval(()=>{ if(currentTab===0) fetchAlerts(); }, 10000);
        // Notification push (si support√©)
        if ('Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
